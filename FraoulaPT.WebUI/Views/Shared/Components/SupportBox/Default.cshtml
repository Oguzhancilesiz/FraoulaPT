@using FraoulaPT.WebUI.Models.ViewModels.QuestionAnsverViewModel
@model SupportBoxViewModel

<form id="questionForm" class="bg-dark text-light p-3 rounded shadow-sm">
    @Html.AntiForgeryToken()
    <input type="hidden" name="UserPackageId" value="@Model.UserPackageId" />
    <input type="hidden" name="AskedByUserId" value="@Model.CurrentUserId" />

    <!-- Koç seç -->
    <div class="mb-3">
        <label class="form-label fw-semibold text-warning">🎯 Koç Seç</label>
        <select id="coach-select" name="AnsweredByCoachId" class="form-select bg-dark text-light border-secondary" required>
            @foreach (var coach in Model.Coaches ?? Enumerable.Empty<dynamic>())
            {
                <option value="@coach.Id" data-image="@coach.ProfilePhotoUrl">@coach.FullName</option>
            }
        </select>
        <div id="coachPreview" class="d-flex align-items-center gap-2 mt-2 small text-muted"></div>
    </div>

    <!-- Soru -->
    <div class="mb-3">
        <label for="questionText" class="form-label fw-semibold text-warning mb-1">✏️ Sorunuz</label>
        <textarea class="form-control ring bg-dark text-light border-secondary"
                  id="questionText" name="QuestionText" rows="3"
                  placeholder="Sorunuzu buraya yazın..."
                  maxlength="500" required></textarea>
        <div class="d-flex justify-content-between mt-1 small">
            <span class="text-muted">En fazla 500 karakter</span>
            <span id="qCounter" class="text-muted">0/500</span>
        </div>
    </div>

    <!-- Gönder Butonu -->
    <div class="d-grid">
        <button type="submit" id="askBtn" class="btn fw-semibold text-white"
                style="background:var(--brand-grad);border:0;">
            <span class="btn-label"><i class="bi bi-send"></i> Soruyu Gönder</span>
            <span class="btn-spinner d-none">
                <span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>
                Gönderiliyor...
            </span>
        </button>
    </div>
</form>

<!-- Geçmiş Sorular -->
<hr class="border-secondary" />
<div id="questionHistory" class="p-3 rounded shadow-sm"
     style="background:var(--surface);color:var(--text);border:1px solid var(--border);">
    <div class="text-center my-2 text-muted">Sorular yükleniyor...</div>
</div>

@section Scripts {
    <script>
        // Karakter sayacı
        const qArea = document.getElementById('questionText');
        const qCounter = document.getElementById('qCounter');
        qArea?.addEventListener('input', () => { if (qCounter) qCounter.textContent = `${qArea.value.length}/500`; });

        // Koç önizleme
        document.getElementById('coach-select')?.addEventListener('change', function () {
          const opt = this.selectedOptions?.[0];
          const preview = document.getElementById('coachPreview');
          if (!opt || !preview) return;
          preview.innerHTML = `
            <img src="${opt.getAttribute('data-image') || ''}" alt="Koç" class="rounded-circle" width="24" height="24"
                 style="object-fit:cover;border:1px solid var(--border)">
            <span>${opt.textContent || ''}</span>`;
        });

        // Buton spinner (merkezi AJAX handler yoksa basit fallback)
        const askBtn = document.getElementById('askBtn');
        document.getElementById('questionForm')?.addEventListener('submit', () => {
          if (!askBtn) return;
          askBtn.disabled = true;
          askBtn.querySelector('.btn-label')?.classList.add('d-none');
          askBtn.querySelector('.btn-spinner')?.classList.remove('d-none');
          setTimeout(() => {
            askBtn.disabled = false;
            askBtn.querySelector('.btn-label')?.classList.remove('d-none');
            askBtn.querySelector('.btn-spinner')?.classList.add('d-none');
          }, 3000);
        });
    </script>
}
