@model FraoulaPT.DTOs.UserProgramDTO.WorkoutProgramDTO
@{
    var currentUserId = (Guid)ViewBag.CurrentUserId;
    ViewBag.Title = "Antrenman Programı Detayı";
    string[] gunler = { "Pazartesi", "Salı", "Çarşamba", "Perşembe", "Cuma", "Cumartesi", "Pazar" };
}

<div class="container my-3">
    <div class="mx-auto text-center mb-4">
        <h2 class="fw-bold mb-2 text-primary">@Model.Title</h2>
        <div class="lead mb-1">
            <span class="badge bg-light text-dark me-2"><b>Başlangıç:</b> @Model.StartDate:dd.MM.yyyy</span>
            <span class="badge bg-light text-dark"><b>Bitiş:</b> @Model.EndDate:dd.MM.yyyy</span>
        </div>
        <div class="mb-1 small text-secondary">
            <b>Koç Notu:</b> <span class="fst-italic">@Model.CoachNote</span>
        </div>
    </div>
    <hr />
    @if (Model.Days == null || !Model.Days.Any())
    {
        <div class="alert alert-warning text-center my-4">Bu programda henüz bir gün ve egzersiz eklenmemiş.</div>
    }
    else
    {
        <div class="row gy-4">
            @foreach (var day in Model.Days.OrderBy(d => d.DayOfWeek))
            {
                <div class="col-12 col-lg-6">
                    <div class="card shadow-lg border-0 h-100">
                        <div class="card-header bg-primary text-white fs-5 text-center">
                            @(gunler.Length >= day.DayOfWeek && day.DayOfWeek >= 1 ? gunler[day.DayOfWeek - 1] : $"Gün {day.DayOfWeek}")
                        </div>
                        <div class="card-body p-3">
                            @if (day.Exercises == null || !day.Exercises.Any())
                            {
                                <div class="alert alert-info text-center mb-0">Bu güne egzersiz eklenmemiş.</div>
                            }
                            else
                            {
                                <div class="table-responsive">
                                    <table class="table table-hover align-middle mb-0">
                                        <thead class="table-light">
                                            <tr class="text-center align-middle">
                                                <th>Hareket</th>
                                                <th>Görsel</th>
                                                <th>Video</th>
                                                <th>Set</th>
                                                <th>Tekrar</th>
                                                <th>Kg</th>
                                                <th>Koç Notu</th>
                                                <th style="min-width:180px;">Kendi Kaydın</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @foreach (var ex in day.Exercises)
                                            {
                                                <tr class="text-center align-middle">
                                                    <td class="fw-semibold">@ex.ExerciseName</td>
                                                    <td>
                                                        @if (!string.IsNullOrEmpty(ex.ImageUrl))
                                                        {
                                                            <img src="@ex.ImageUrl" alt="@ex.ExerciseName görseli"
                                                                 class="img-fluid rounded border shadow-sm mx-auto d-block"
                                                                 style="max-width:70px;max-height:70px;object-fit:cover;" />
                                                        }
                                                        else
                                                        {
                                                            <span class="text-muted small">Yok</span>
                                                        }
                                                    </td>
                                                    <td>
                                                        @if (!string.IsNullOrEmpty(ex.VideoUrl))
                                                        {
                                                            @if (ex.VideoUrl.Contains("youtube"))
                                                            {
                                                                var videoId = "";
                                                                var youtubeMatch = System.Text.RegularExpressions.Regex.Match(ex.VideoUrl, @"(?:youtube\.com/watch\?v=|youtu\.be/)([A-Za-z0-9_-]+)");
                                                                if (youtubeMatch.Success)
                                                                { videoId = youtubeMatch.Groups[1].Value; }
                                                                else if (ex.VideoUrl.Contains("embed"))
                                                                { videoId = ex.VideoUrl.Split("embed/").Last(); }
                                                                if (!string.IsNullOrEmpty(videoId))
                                                                {
                                                                    <div class="ratio ratio-16x9">
                                                                        <iframe src="https://www.youtube.com/embed/@videoId" allowfullscreen class="rounded"></iframe>
                                                                    </div>
                                                                }
                                                                else
                                                                {
                                                                    <a href="@ex.VideoUrl" target="_blank" class="btn btn-outline-danger btn-sm">YouTube</a>
                                                                }
                                                            }
                                                            else
                                                            {
                                                                <a href="@ex.VideoUrl" target="_blank" class="btn btn-outline-secondary btn-sm">Video İzle</a>
                                                            }
                                                        }
                                                        else
                                                        {
                                                            <span class="text-muted small">Yok</span>
                                                        }
                                                    </td>
                                                    <td>@ex.SetCount</td>
                                                    <td>@ex.RepetitionCount</td>
                                                    <td>@(ex.Weight.HasValue ? ex.Weight.Value.ToString("0.##") : "-")</td>
                                                    <td class="small">@ex.CoachNote</td>
                                                    <td>
                                                        <form class="exercise-log-form bg-light p-2 rounded shadow-sm" style="min-width:180px;">
                                                            <input type="hidden" name="WorkoutExerciseId" value="@ex.Id" />
                                                            <input type="hidden" name="ProgramId" value="@Model.Id" />
                                                            <input type="hidden" name="IsCompleted" value="true" />
                                                            <input type="hidden" name="CompletedAt" value="@DateTime.Now" />
                                                            <div class="row gx-1 gy-1">
                                                                <div class="col-4">
                                                                    <input type="number" name="ActualSetCount" value="@ex.LastLog?.ActualSetCount"
                                                                           placeholder="Set" class="form-control form-control-sm" min="0" />
                                                                </div>
                                                                <div class="col-4">
                                                                    <input type="number" name="ActualRepetitionCount" value="@ex.LastLog?.ActualRepetitionCount"
                                                                           placeholder="Tekrar" class="form-control form-control-sm" min="0" />
                                                                </div>
                                                                <div class="col-4">
                                                                    <input type="number" step="0.1" name="ActualWeight" value="@ex.LastLog?.ActualWeight"
                                                                           placeholder="Kg" class="form-control form-control-sm" min="0" />
                                                                </div>
                                                            </div>
                                                            <div class="mt-1">
                                                                <input type="text" name="UserNote" value="@ex.LastLog?.UserNote"
                                                                       placeholder="Not (Zorlandım, ağırlık düştüm, vs)" class="form-control form-control-sm" />
                                                            </div>
                                                            <button type="submit" class="btn btn-sm btn-success mt-2 w-100">
                                                                <i class="bi bi-save2"></i> Kaydet
                                                            </button>
                                                            <span class="log-result small"></span>
                                                        </form>
                                                    </td>
                                                </tr>
                                            }
                                        </tbody>
                                    </table>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            }
        </div>
    }
</div>

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        $(function(){
            $(".exercise-log-form").submit(function(e){
                e.preventDefault();
                var $form = $(this);
                var data = $form.serialize();
                $.ajax({
                    url: '/WorkoutExerciseLog/CreateAjax',
                    method: 'POST',
                    data: data,
                    success: function(resp){
                        $form.find(".log-result").text("Kaydedildi!").css("color","green");
                    },
                    error: function(){
                        $form.find(".log-result").text("Hata!").css("color","red");
                    }
                });
            });
        });
    </script>
    <!-- Bootstrap iconlar için (isteğe bağlı) -->
}
