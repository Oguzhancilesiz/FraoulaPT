@using FraoulaPT.Entity
@model WorkoutDay
@{
    ViewData["Title"] = "Antrenmana Başla";

    var groupedByCategory = Model.Exercises
        .GroupBy(e => e.Exercise.Category)
        .OrderBy(g => g.Key?.Name)
        .ToList();
}

<div class="container py-4">
    <h2 class="text-primary fw-bold mb-3">@((DayOfWeek)Model.DayOfWeek) Antrenmanı</h2>
    <p class="text-muted mb-4">@Model.Description</p>

    @if (!Model.Exercises.Any())
    {
        <div class="alert alert-warning text-center">Bu güne ait egzersiz bulunmamaktadır.</div>
    }

    @foreach (var categoryGroup in groupedByCategory)
    {
        <div class="card mb-4 border-0 shadow-sm">
            <div class="card-header bg-light border-bottom">
                <h6 class="fw-bold text-dark mb-0">@categoryGroup.Key?.Name"</h6>
            </div>
            <div class="card-body p-3">
                @foreach (var ex in categoryGroup)
                {
                    var exercise = ex.Exercise;
                    <div class="row mb-3 align-items-center gy-2">
                        <div class="col-3 col-md-2">
                            @if (!string.IsNullOrEmpty(exercise.ImageUrl))
                            {
                                <img src="@exercise.ImageUrl" class="img-fluid rounded" style="max-height: 80px; object-fit: cover;" alt="@exercise.Name" />
                            }
                        </div>
                        <div class="col-9 col-md-10">
                            <div class="d-flex justify-content-between">
                                <strong class="text-primary">@exercise.Name</strong>
                                @if (!string.IsNullOrEmpty(exercise.VideoUrl))
                                {
                                    <a class="btn btn-sm btn-outline-secondary" target="_blank"
                                       href="@exercise.VideoUrl">
                                        🎥 İzle
                                    </a>
                                }
                            </div>
                            <div class="text-muted small">
                                <span>@ex.SetCount set x @ex.Repetition tekrar</span>
                                @if (ex.Weight.HasValue)
                                {
                                    <span> | @ex.Weight kg</span>
                                }
                                @if (!string.IsNullOrWhiteSpace(ex.Note))
                                {
                                    <div class="text-secondary mt-1">📝 <em>@ex.Note</em></div>
                                }
                            </div>
                        </div>
                        <form class="feedback-form mt-2" data-exercise-id="@ex.Id">
                            <div class="row g-2 align-items-end">
                                <div class="col-12 col-md-6">
                                    <label class="form-label small">📝 Geri Bildirim</label>
                                    <textarea name="FeedbackText" class="form-control form-control-sm" rows="2" placeholder="Bu set zor geldi, tekrar azalttım..."></textarea>
                                </div>
                                <div class="col-4 col-md-2">
                                    <label class="form-label small">✅ Tekrar</label>
                                    <input name="ActualReps" type="number" class="form-control form-control-sm" placeholder="gerçekleşen tekrar"/>
                                </div>
                                <div class="col-4 col-md-2">
                                    <label class="form-label small">🏋️‍♂️ Kilo</label>
                                    <input name="ActualWeight" type="number" step="0.1" class="form-control form-control-sm" placeholder="gerçekleşen kilo" />
                                </div>
                                <div class="col-4 col-md-2">
                                    <label class="form-label small">📊 RPE</label>
                                    <select name="RPE" class="form-select form-select-sm">
                                        <option value="0">Sana göre Harcadığın Efor</option>
                                        @for (int i = 1; i <= 10; i++)
                                        {
                                            <option value="@i">@i</option>
                                        }
                                    </select>
                                </div>
                                <div class="col-12 mt-2">
                                    <button type="submit" class="btn btn-sm btn-outline-success">✔️ Gönder</button>
                                    <span class="text-success small ms-2 feedback-success" style="display:none;">Kaydedildi ✅</span>
                                </div>
                            </div>
                        </form>

                    </div>

                    <hr class="my-2" />
                }
            </div>
        </div>
    }
</div>

@section Scripts {
    <script>
        document.querySelectorAll('.feedback-form').forEach(form => {
            form.addEventListener('submit', async function (e) {
                e.preventDefault();

                const exerciseId = form.getAttribute('data-exercise-id');
                const formData = new FormData(form);
                formData.append("WorkoutExerciseId", exerciseId);

                const submitButton = form.querySelector("button[type='submit']");
                const successMsg = form.querySelector('.feedback-success');
                const errorMsg = form.querySelector('.feedback-error');

                // butonu devre dışı bırak
                submitButton.disabled = true;
                submitButton.innerText = "Gönderiliyor...";

                try {
                    const response = await fetch('/Workout/SubmitFeedback', {
                        method: 'POST',
                        body: formData
                    });

                    if (response.ok) {
                        // Başarı mesajı göster
                        successMsg.style.display = 'inline';
                        errorMsg.style.display = 'none';

                        setTimeout(() => {
                            successMsg.style.display = 'none';
                        }, 4000);
                    } else {
                        const data = await response.json();
                        errorMsg.textContent = data?.error || "Beklenmeyen bir hata oluştu.";
                        errorMsg.style.display = 'inline';
                    }
                } catch (err) {
                    errorMsg.textContent = "Sunucuya bağlanırken hata oluştu.";
                    errorMsg.style.display = 'inline';
                } finally {
                    submitButton.disabled = false;
                    submitButton.innerText = "✔️ Gönder";
                }
            });
        });
    </script>
}
