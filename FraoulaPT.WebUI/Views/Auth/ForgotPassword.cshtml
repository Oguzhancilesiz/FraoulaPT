@using FraoulaPT.DTOs.AuthDTOs
@model UserForgotPasswordDTO

@{
    Layout = "~/Views/Shared/_Layout.cshtml";
    ViewData["Title"] = "Şifremi Unuttum";
    var waitSeconds = ViewBag.ResetPasswordWaitSeconds ?? 0;
}

<div class="container py-5" style="max-width:640px">
    <div class="card border-0 shadow-lg" style="background:var(--surface);color:var(--text);border:1px solid var(--border)">
        <div class="card-body p-4 p-md-5">
            <div class="d-flex align-items-center gap-3 mb-3">
                <div class="rounded-3 d-grid place-items-center" style="width:56px;height:56px;background:var(--brand-grad);color:#fff">
                    <i class="bi bi-lock-fill fs-4"></i>
                </div>
                <div>
                    <h3 class="mb-1">Şifremi Unuttum</h3>
                    <div class="text-muted">E-posta adresine bir sıfırlama bağlantısı göndereceğiz.</div>
                </div>
            </div>

            @if (ViewBag.Info != null)
            {
                <div class="alert alert-info text-center">@ViewBag.Info</div>
            }

            @if (waitSeconds > 0)
            {
                <div id="wait-message" class="alert alert-warning text-center small" style="background:rgba(255,193,7,.08);border-color:var(--border);color:var(--text)">
                    📩 Bağlantı gönderildi. Yeni bir istek için <b><span id="timer">@waitSeconds</span></b> saniye bekleyiniz.
                </div>
            }

            <form asp-action="ForgotPassword" method="post" id="forgotForm" novalidate>
                @Html.AntiForgeryToken()

                <div asp-validation-summary="All" class="text-danger small mb-3"></div>

                <div class="mb-3">
                    <label asp-for="Email" class="form-label fw-semibold">E-posta Adresi</label>
                    <input asp-for="Email" class="form-control ring" type="email" autocomplete="email" placeholder="ornek@mail.com" />
                    <span asp-validation-for="Email" class="text-danger small"></span>
                </div>

                <button type="submit" id="forgotBtn" class="btn btn-accent w-100 fw-semibold" @(waitSeconds > 0 ? "disabled" : "")>
                    <i class="bi bi-send me-1"></i> Şifre Sıfırlama Bağlantısı Gönder
                </button>
            </form>

            <div class="alert alert-secondary mt-4 mb-0 small" style="background:rgba(255,255,255,.03);border-color:var(--border);color:var(--muted)">
                <i class="bi bi-info-circle me-1"></i>
                E-postadaki bağlantı sınırlı süre geçerlidir. Gelen kutusu ve gereksiz/Spam klasörünü kontrol etmeyi unutmayın.
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    @if (waitSeconds > 0)
    {
        <script>
            (function(){
              let seconds = @waitSeconds;
              const btn = document.getElementById('forgotBtn');
              const timerSpan = document.getElementById('timer');
              const msg = document.getElementById('wait-message');
              const tick = setInterval(()=>{
                seconds--;
                if (timerSpan) timerSpan.textContent = seconds;
                if (seconds <= 0){
                  clearInterval(tick);
                  if (msg) msg.style.display = 'none';
                  if (btn) btn.disabled = false;
                }
              }, 1000);
            })();
        </script>
    }
    <script>
        // Basit UX: geçersiz e-posta için butonu pasifleştir, gönderimde spinner göster
        (function () {
          const form = document.getElementById('forgotForm');
          const input = document.getElementById('Email') || document.querySelector('[name="Email"]');
          const btn = document.getElementById('forgotBtn');

          function toggle() {
            if (!input || !btn) return;
            if (btn.hasAttribute('disabled')) return; // rate-limit aktifken dokunma
            btn.disabled = !(input.value && input.checkValidity());
          }
          input?.addEventListener('input', toggle);
          toggle();

          form?.addEventListener('submit', function () {
            if (!btn) return;
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span> Gönderiliyor...';
          });
        })();
    </script>
}
