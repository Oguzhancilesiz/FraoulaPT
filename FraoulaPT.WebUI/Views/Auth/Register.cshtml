@using FraoulaPT.DTOs.AuthDTOs
@model UserRegisterDTO
@{
    ViewData["Title"] = "Kayıt Ol";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container py-5" style="max-width:720px">
    <div class="card border-0 shadow-lg" style="background:var(--surface);color:var(--text);border:1px solid var(--border)">
        <div class="card-body p-4 p-md-5">
            <!-- Başlık -->
            <div class="d-flex align-items-center gap-3 mb-3">
                <div class="rounded-3 d-grid place-items-center" style="width:56px;height:56px;background:var(--brand-grad);color:#fff">
                    <i class="bi bi-person-plus-fill fs-4"></i>
                </div>
                <div>
                    <h3 class="mb-1">Kayıt Ol</h3>
                    <div class="text-muted">Hızlıca hesabını oluştur ve başla.</div>
                </div>
            </div>

            <form asp-action="Register" method="post" id="registerForm" novalidate>
                @Html.AntiForgeryToken()

                <div asp-validation-summary="All" class="text-danger small mb-3"></div>

                <!-- Ad Soyad -->
                <div class="mb-3">
                    <label asp-for="FullName" class="form-label fw-semibold">Ad Soyad</label>
                    <div class="input-group">
                        <span class="input-group-text"><i class="bi bi-person-fill"></i></span>
                        <input asp-for="FullName" class="form-control ring" autocomplete="name" placeholder="Adınız Soyadınız" />
                    </div>
                    <span asp-validation-for="FullName" class="text-danger small"></span>
                </div>

                <!-- Kullanıcı Adı -->
                <div class="mb-3">
                    <label asp-for="UserName" class="form-label fw-semibold">Kullanıcı Adı</label>
                    <div class="input-group">
                        <span class="input-group-text"><i class="bi bi-person-badge-fill"></i></span>
                        <input asp-for="UserName" class="form-control ring" autocomplete="username" placeholder="kullanici123" />
                    </div>
                    <span asp-validation-for="UserName" class="text-danger small"></span>
                </div>

                <!-- E-posta -->
                <div class="mb-3">
                    <label asp-for="Email" class="form-label fw-semibold">E-posta</label>
                    <div class="input-group">
                        <span class="input-group-text"><i class="bi bi-envelope-fill"></i></span>
                        <input asp-for="Email" class="form-control ring" type="email" autocomplete="email" placeholder="mail@ornek.com" />
                    </div>
                    <span asp-validation-for="Email" class="text-danger small"></span>
                </div>

                <!-- Şifre -->
                <div class="mb-3">
                    <label asp-for="Password" class="form-label fw-semibold">Şifre</label>
                    <div class="input-group">
                        <span class="input-group-text"><i class="bi bi-lock-fill"></i></span>
                        <input asp-for="Password" id="Password" type="password" class="form-control ring" autocomplete="new-password" placeholder="••••••••" />
                        <button class="btn btn-outline-secondary toggle-pass" type="button" aria-label="Göster/Gizle"><i class="bi bi-eye"></i></button>
                    </div>
                    <div class="mt-2">
                        <div class="progress" style="height:6px;">
                            <div id="pwdStrength" class="progress-bar" role="progressbar" style="width:0%"></div>
                        </div>
                        <small id="pwdHint" class="text-muted">En az 6 karakter; mümkünse büyük/küçük harf, rakam ve sembol.</small>
                    </div>
                    <span asp-validation-for="Password" class="text-danger small"></span>
                </div>

                <!-- Şifre Tekrar -->
                <div class="mb-4">
                    <label asp-for="ConfirmPassword" class="form-label fw-semibold">Şifre Tekrar</label>
                    <div class="input-group">
                        <span class="input-group-text"><i class="bi bi-lock-fill"></i></span>
                        <input asp-for="ConfirmPassword" id="ConfirmPassword" type="password" class="form-control ring" autocomplete="new-password" placeholder="••••••••" />
                        <button class="btn btn-outline-secondary toggle-pass" type="button" aria-label="Göster/Gizle"><i class="bi bi-eye"></i></button>
                    </div>
                    <small id="matchHint" class="text-muted d-block mt-1">Tekrar şifre, yeni şifreyle aynı olmalı.</small>
                    <span asp-validation-for="ConfirmPassword" class="text-danger small"></span>
                </div>

                <!-- Submit -->
                <div class="d-grid gap-2">
                    <button type="submit" class="btn btn-accent fw-semibold" id="registerBtn">
                        <i class="bi bi-person-check-fill me-1"></i> Kayıt Ol
                    </button>
                </div>
            </form>

            <!-- Alt Link -->
            <div class="mt-4 text-center small">
                Zaten hesabın var mı?
                <a asp-action="Login" class="text-decoration-none ms-1"><i class="bi bi-box-arrow-in-right"></i> Giriş Yap</a>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        // Şifre göster/gizle
        document.querySelectorAll('.toggle-pass').forEach(btn => {
          btn.addEventListener('click', () => {
            const input = btn.previousElementSibling; // password input
            if (!input) return;
            input.type = input.type === 'password' ? 'text' : 'password';
            const icon = btn.querySelector('i');
            icon?.classList.toggle('bi-eye');
            icon?.classList.toggle('bi-eye-slash');
          });
        });

        // Şifre gücü + eşleşme + buton kontrolü
        (function () {
          const pwd = document.getElementById('Password');
          const conf = document.getElementById('ConfirmPassword');
          const bar = document.getElementById('pwdStrength');
          const hint = document.getElementById('pwdHint');
          const matchHint = document.getElementById('matchHint');
          const btn = document.getElementById('registerBtn');
          const form = document.getElementById('registerForm');
          const nameEl = document.getElementById('FullName') || document.querySelector('[name="FullName"]');
          const userEl = document.getElementById('UserName') || document.querySelector('[name="UserName"]');
          const mailEl = document.getElementById('Email') || document.querySelector('[name="Email"]');

          function strengthScore(v) {
            if (!v) return 0;
            let s = 0;
            if (v.length >= 8) s++;
            if (/[A-Z]/.test(v)) s++;
            if (/[a-z]/.test(v)) s++;
            if (/[0-9]/.test(v)) s++;
            if (/[^A-Za-z0-9]/.test(v)) s++;
            return Math.min(s, 4); // 0..4
          }

          function render() {
            const v = pwd?.value || '';
            const score = strengthScore(v);
            const pct = [0, 25, 50, 75, 100][score];
            if (bar) {
              bar.style.width = pct + '%';
              bar.className = 'progress-bar';
              if (score <= 1) bar.classList.add('bg-danger');
              else if (score === 2) bar.classList.add('bg-warning');
              else if (score === 3) bar.classList.add('bg-info');
              else bar.classList.add('bg-success');
            }
            if (hint) {
              hint.textContent =
                score <= 1 ? 'Zayıf şifre' :
                score === 2 ? 'Orta seviye' :
                score === 3 ? 'İyi' : 'Güçlü';
            }

            const match = (conf?.value || '') === v && v.length >= 6;
            if (matchHint) matchHint.textContent = match ? 'Şifreler eşleşiyor.' : 'Tekrar şifre, yeni şifreyle aynı olmalı.';

            const filled = (nameEl?.value?.trim().length > 0) && (userEl?.value?.trim().length > 0) && (mailEl?.checkValidity?.() ?? false);
            btn.disabled = !(filled && match && score >= 2);
          }

          [pwd, conf, nameEl, userEl, mailEl].forEach(i => i?.addEventListener('input', render));
          render();

          form?.addEventListener('submit', function () {
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span> Kaydediliyor...';
          });
        })();
    </script>
}
