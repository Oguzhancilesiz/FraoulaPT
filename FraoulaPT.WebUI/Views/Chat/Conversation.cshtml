@using FraoulaPT.DTOs.ChatMessageDTO
@model MyChatViewModel

<div class="card shadow-sm" style="max-width:600px;margin:auto;">
    <div class="card-header">
        <b>@Model.Coach.CoachFullName</b>
        <span class="badge bg-info ms-2">Kalan mesaj: @Model.Coach.RemainingMessageCount</span>
    </div>
    <div class="card-body" style="height:320px; overflow-y:scroll;" id="chatBody">
        @foreach (var msg in Model.Messages)
        {
            <div class="mb-2 @(msg.IsMine ? "text-end" : "text-start")">
                <span class="px-3 py-2 rounded-pill bg-light">@msg.MessageText</span>
            </div>
        }
    </div>
    <div class="input-group mt-2">
        <input type="text" id="msgInput" class="form-control" placeholder="Mesajınızı yazın..." autocomplete="off" />
        <button class="btn btn-success" id="sendBtn">Gönder</button>
    </div>
</div>

@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.12/signalr.min.js"></script>
    <script>
        // Buraya yukarıda paylaştığım SignalR client kodunu ekle
        // Model'den UserId ve CoachId Razor ile ver
        const currentUserId = '@Model.CurrentUserId';
        const coachId = '@Model.Coach.CoachId';
        // ...veya ViewBag’den alabilirsin
        // Kodları buraya ekle!
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.12/signalr.min.js"></script>
    <script>
        const connection = new signalR.HubConnectionBuilder()
            .withUrl("/chathub")
            .build();

        connection.on("ReceiveMessage", function (message, isMine) {
            // Mesajı ekle
        });

        connection.start();

        document.getElementById("sendBtn").onclick = function() {
            const msg = document.getElementById("msgInput").value;
            connection.invoke("SendMessage", "@Model.CurrentUserId", "@Model.Coach.CoachId", msg);
            document.getElementById("msgInput").value = "";
        };
    </script>
}
