@model List<FraoulaPT.DTOs.ChatMessageDTO.ChatMessageDTO>
@{
    var currentUserId = ViewBag.CurrentUserId as Guid?;
    var coachId = ViewBag.CoachId as Guid?;
    Layout = "_Layout";
}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" />

<style>
    .fraoula-chat-wrapper {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: #f7f7fa;
        z-index: 99999;
        display: flex;
        flex-direction: column;
    }

    .fraoula-chat-header {
        flex-shrink: 0;
        padding: 12px 18px;
        background: linear-gradient(90deg, #536976 0, #292e49 100%);
        color: #fff;
        font-size: 20px;
        font-weight: 600;
        display: flex;
        align-items: center;
        justify-content: space-between;
        border-bottom: 1px solid #eaeaea;
    }

    .fraoula-chat-body {
        flex: 1 1 auto;
        overflow-y: auto;
        padding: 18px 8vw 18px 8vw;
        background: #f7f7fa;
    }

    .fraoula-chat-footer {
        flex-shrink: 0;
        background: #fff;
        padding: 10px 8vw 16px 8vw;
        border-top: 1px solid #eee;
        display: flex;
        flex-direction: row;
        gap: 6px;
    }
    media (max-width: 900px) {
        .fraoula-chat-body, .fraoula-chat-footer

    {
        padding-left: 5vw;
        padding-right: 5vw;
    }

    }
    media (max-width: 600px) {
        .fraoula-chat-header

    {
        font-size: 17px;
    }

    .fraoula-chat-body, .fraoula-chat-footer {
        padding-left: 3vw;
        padding-right: 3vw;
    }

    }
    media (max-width: 450px) {
        .fraoula-chat-footer

    {
        padding: 6px 1vw 12px 1vw;
    }

    .fraoula-chat-body {
        padding: 8px 2vw 8px 2vw;
    }

    }
</style>

<div class="fraoula-chat-wrapper">
    <div class="fraoula-chat-header">
        <span><i class="bi bi-chat-text"></i> Koçumla Sohbet</span>
        <button type="button" onclick="window.location='@Url.Action("Index", "Profile")'" class="btn btn-light btn-sm">
            <i class="bi bi-x-lg"></i> Kapat
        </button>
    </div>
    <div id="chatBody" class="fraoula-chat-body">
        @foreach (var msg in Model)
        {
            <div class="mb-3 @(msg.SenderId == currentUserId ? "text-end" : "text-start")">
                <div class="d-inline-block px-3 py-2 rounded" style="background:@(msg.SenderId == currentUserId ? "#c4ffcf" : "#eee"); min-width:70px;max-width:90vw;">
                    <span>@msg.MessageText</span>
                    @if (msg.MediaFiles != null && msg.MediaFiles.Any())
                    {
                        foreach (var media in msg.MediaFiles)
                        {
                            if (media.MediaType == "image")
                            {
                                <img src="@media.MediaUrl" style="max-width:140px; max-height:140px; margin:8px 0;" />
                            }
                            else if (media.MediaType == "video")
                            {
                                <video src="@media.MediaUrl" controls style="max-width:180px;max-height:120px;margin:8px 0;"></video>
                            }
                            else
                            {
                                <a href="@media.MediaUrl" target="_blank" style="display:block">@media.FileName</a>
                            }
                        }
                    }
                </div>
                <div style="font-size:11px; opacity:.6">@msg.SentAt.ToShortTimeString()</div>
            </div>
        }
    </div>
    <form id="chatForm" class="fraoula-chat-footer d-flex align-items-center" enctype="multipart/form-data" autocomplete="off">
        <input type="text" name="message" id="msgInput" class="form-control me-2" autocomplete="off" placeholder="Mesajınız..." maxlength="800" required />
        <input type="file" id="mediaInput" name="mediaFiles" multiple class="form-control" accept=".jpg,.jpeg,.png,.gif,.mp4,.pdf,.docx,.xlsx" style="max-width:140px;" />
        <button type="submit" class="btn btn-success ms-2" style="min-width:72px;"><i class="bi bi-send"></i> Gönder</button>
    </form>
</div>

@section Scripts {
  


    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.12/signalr.min.js"></script>
    <script>
        // SignalR connection
        const connection = new signalR.HubConnectionBuilder()
            .withUrl("/chathub")
            .build();

        connection.on("ReceiveMessage", function (message, isMine) {
            let chatBody = document.getElementById("chatBody");
            let html = `<div class="mb-3 ${isMine ? "text-end" : "text-start"}">
                            <div class="d-inline-block px-3 py-2 rounded" style="background:${isMine ? "#c4ffcf" : "#eee"};min-width:70px;max-width:90vw;">
                                <span>${message.messageText || ""}</span>`;
            if (message.mediaFiles) {
                for (const media of message.mediaFiles) {
                    if (media.mediaType === "image")
                        html += `<img src="${media.mediaUrl}" style="max-width:140px;max-height:140px;margin:8px 0;" />`;
                    else if (media.mediaType === "video")
                        html += `<video src="${media.mediaUrl}" controls style="max-width:180px;max-height:120px;margin:8px 0;"></video>`;
                    else
                        html += `<a href="${media.mediaUrl}" target="_blank" style="display:block">${media.fileName}</a>`;
                }
            }
            html += `   </div>
                        <div style="font-size:11px; opacity:.6">${new Date(message.sentAt).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>
                    </div>`;
            chatBody.innerHTML += html;
            chatBody.scrollTop = chatBody.scrollHeight;
        });

        connection.start();

        // Ajax ile form submit (dosya ve mesaj)
        document.getElementById("chatForm").onsubmit = async function (e) {
            e.preventDefault();
            let formData = new FormData(this);
            let resp = await fetch('/Chat/Send', { method: 'POST', body: formData });
            if (resp.ok) document.getElementById("msgInput").value = "";
        }
    </script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" />
}
