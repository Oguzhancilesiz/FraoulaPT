@model FraoulaPT.DTOs.UserWeeklyFormDTOs.UserWeeklyFormCreateDTO

@{
    ViewData["Title"] = "Haftalık Form Ekle";
    Layout = "~/Views/Shared/_Layout.cshtml";

    // FormDate için güvenli varsayılan (bugün)
    DateTime nowLocal = DateTime.Now;
    DateTime? fd = Model?.FormDate;
    var formDateStr = ((fd == null || fd == default(DateTime)) ? nowLocal : fd.Value).ToString("yyyy-MM-dd");
}

<style>
    .ring {
        background-color: #111;
        color: #f1f1f1;
        border: 1px solid #2f2f2f;
    }

        .ring:focus {
            outline: none;
            box-shadow: 0 0 0 .2rem rgba(255,136,0,.25);
            border-color: #ff8800;
        }

    .thumb {
        width: 100%;
        height: 160px;
        object-fit: cover;
        border-radius: 10px;
        border: 1px solid #2f2f2f;
    }
</style>

<div class="container py-4">
    <div class="card shadow-lg border-0 rounded-3" style="background:var(--surface);color:var(--text);border:1px solid var(--border);">
        <div class="card-header fw-bold text-center" style="background:var(--brand-grad);color:#fff;border-top-left-radius:12px;border-top-right-radius:12px;">
            <i class="bi bi-journal-plus me-2"></i> Haftalık Form Ekle
        </div>

        <div class="card-body p-4">
            <form asp-action="Create" method="post" enctype="multipart/form-data" id="weeklyForm">
                @Html.AntiForgeryToken()
                <div asp-validation-summary="All" class="text-danger small mb-3"></div>

                <div class="row g-3">
                    <!-- Sol sütun -->
                    <div class="col-md-6">
                        <label asp-for="FormDate" class="form-label">Tarih</label>
                        <input asp-for="FormDate" type="date" class="form-control ring"
                               value="@formDateStr" max="@DateTime.Now.ToString("yyyy-MM-dd")" />

                        <label asp-for="Weight" class="form-label mt-3">Kilo (kg)</label>
                        <input asp-for="Weight" type="number" step="0.1" inputmode="decimal" class="form-control ring" />

                        <label asp-for="FatPercent" class="form-label mt-3">Yağ Oranı (%)</label>
                        <input asp-for="FatPercent" type="number" step="0.1" inputmode="decimal" class="form-control ring" />

                        <label asp-for="MuscleMass" class="form-label mt-3">Kas Kütlesi (kg)</label>
                        <input asp-for="MuscleMass" type="number" step="0.1" inputmode="decimal" class="form-control ring" />

                        <label asp-for="RestingPulse" class="form-label mt-3">Dinlenik Nabız</label>
                        <input asp-for="RestingPulse" type="number" step="1" inputmode="numeric" class="form-control ring" />

                        <label asp-for="BloodPressure" class="form-label mt-3">Tansiyon</label>
                        <input asp-for="BloodPressure" class="form-control ring" placeholder="Örn: 120/80" />
                    </div>

                    <!-- Sağ sütun -->
                    <div class="col-md-6">
                        <label asp-for="Waist" class="form-label">Bel (cm)</label>
                        <input asp-for="Waist" type="number" step="0.1" inputmode="decimal" class="form-control ring" />

                        <label asp-for="Hip" class="form-label mt-3">Kalça (cm)</label>
                        <input asp-for="Hip" type="number" step="0.1" inputmode="decimal" class="form-control ring" />

                        <label asp-for="Chest" class="form-label mt-3">Göğüs (cm)</label>
                        <input asp-for="Chest" type="number" step="0.1" inputmode="decimal" class="form-control ring" />

                        <label asp-for="Arm" class="form-label mt-3">Kol (cm)</label>
                        <input asp-for="Arm" type="number" step="0.1" inputmode="decimal" class="form-control ring" />

                        <label asp-for="Leg" class="form-label mt-3">Bacak (cm)</label>
                        <input asp-for="Leg" type="number" step="0.1" inputmode="decimal" class="form-control ring" />

                        <label asp-for="Vo2Max" class="form-label mt-3">VO2 Max</label>
                        <input asp-for="Vo2Max" type="number" step="0.1" inputmode="decimal" class="form-control ring" />
                    </div>
                </div>

                <label asp-for="FlexibilityNotes" class="form-label mt-3">Esneklik Notu</label>
                <textarea asp-for="FlexibilityNotes" rows="2" class="form-control ring"></textarea>

                <label asp-for="UserNote" class="form-label mt-3">Kullanıcı Notu</label>
                <textarea asp-for="UserNote" rows="2" class="form-control ring"></textarea>

                <!-- Foto yükleme -->
                <div class="mt-3">
                    <label class="form-label">📸 Progress Fotoğrafları (1-10 adet)</label>
                    <!-- DTO'daki property adıyla aynı kalmalı: ProgressPhotos -->
                    <input asp-for="ProgressPhotos" id="photos" type="file" multiple accept="image/*" class="form-control ring" />
                    <small class="text-muted">Maks. 10 görsel, her biri ≤ 8MB.</small>

                    <!-- Önizleme -->
                    <div id="previews" class="row g-2 mt-2"></div>
                </div>

                <div class="mt-4 text-end d-flex flex-wrap gap-2 justify-content-end">
                    <a asp-controller="UserWeeklyForm" asp-action="Index" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left"></i> Listeye Dön
                    </a>
                    <button type="submit" class="btn btn-warning fw-semibold" id="submitBtn">
                        <i class="bi bi-save2 me-1"></i> Kaydet
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <partial name="_ValidationScriptsPartial" />

    <script>
        // Görsel önizleme + basit validasyon
        const fileInput = document.getElementById('photos');
        const previews = document.getElementById('previews');
        const MAX_FILES = 10;
        const MAX_SIZE = 8 * 1024 * 1024; // 8MB

        fileInput?.addEventListener('change', () => {
          previews.innerHTML = '';
          const files = Array.from(fileInput.files || []);
          if (files.length > MAX_FILES) {
            Swal.fire('Uyarı', `En fazla ${MAX_FILES} görsel yükleyebilirsin.`, 'warning');
            fileInput.value = '';
            return;
          }
          for (const f of files) {
            if (!f.type.startsWith('image/')) {
              Swal.fire('Hata', 'Sadece görsel dosyası yükleyebilirsiniz.', 'error');
              fileInput.value = '';
              previews.innerHTML = '';
              return;
            }
            if (f.size > MAX_SIZE) {
              Swal.fire('Hata', `Her dosya en fazla 8MB olmalı. (${f.name})`, 'error');
              fileInput.value = '';
              previews.innerHTML = '';
              return;
            }
          }
          files.forEach(f => {
            const col = document.createElement('div');
            col.className = 'col-6 col-md-3';
            const img = document.createElement('img');
            img.className = 'thumb';
            img.alt = f.name;
            img.src = URL.createObjectURL(f);
            col.appendChild(img);
            previews.appendChild(col);
          });
        });

        // Onay modalı
        const form = document.getElementById('weeklyForm');
        const submitBtn = document.getElementById('submitBtn');

        form.addEventListener('submit', function (e) {
          e.preventDefault();
          Swal.fire({
            title: 'Emin misin?',
            text: 'Bu formu kaydettikten sonra tekrar düzenleyemezsin!',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#ff7f00',
            cancelButtonColor: '#6c757d',
            confirmButtonText: 'Evet, gönder!',
            cancelButtonText: 'İptal'
          }).then((result) => {
            if (result.isConfirmed) {
              form.submit();
            }
          });
        });
    </script>
}
