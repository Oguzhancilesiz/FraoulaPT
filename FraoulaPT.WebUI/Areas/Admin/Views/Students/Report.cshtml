@using FraoulaPT.DTOs.StudentReportDTOs
@using FraoulaPT.WebUI.Areas.Admin.Models.ViewModels._Shared
@model StudentReportDTO

@{
    ViewData["Title"] = "Öğrenci Raporu";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";

    var header = new PageHeaderVM
            {
                Title = "Öğrenci Raporu",
                Subtitle = "Öğrencinin paket, ölçüm ve iletişim özeti",
                Breadcrumbs = new(){
            new(){ Text="Dashboard",  Url = Url.Action("Index","Dashboard", new{ area="Admin" }) },
            new(){ Text="Öğrenciler", Url = Url.Action("Index","User",      new{ area="Admin" }) },
            new(){ Text="Rapor" }
        },
                Buttons = new(){
            new(){ Text="Yenile", Url=Url.Action("Report","Students", new{ area="Admin", userId=Model.UserId }), Icon="bi-arrow-clockwise", ColorClass="btn-outline-secondary" }
        }
            };

    int qPct = (Model.Package?.TotalQuestions ?? 0) == 0 ? 0 :
               (int)Math.Round(100.0 * (Model.Package?.UsedQuestions ?? 0) / (Model.Package?.TotalQuestions ?? 1));

    int mPct = (Model.Package?.TotalMessages ?? 0) == 0 ? 0 :
               (int)Math.Round(100.0 * (Model.Package?.UsedMessages ?? 0) / (Model.Package?.TotalMessages ?? 1));
}

@await Html.PartialAsync("AdminPartials/_PageHeader", header)

<style>
    /* Kart/başlık uyumu ve taşmaları engelleme */
    .report-card .card-body {
        overflow: hidden
    }

    .avatar-lg {
        width: 64px;
        height: 64px;
        object-fit: cover;
        border-radius: 50%
    }

    .info-chip {
        font-size: .75rem;
        color: var(--muted)
    }

    /* Grafikler sabit yükseklik, içeride scroll yok */
    .chart-wrap {
        position: relative;
        height: 300px;
        width: 100%
    }

    /* Progress bar’lar temaya uygun */
    .progress {
        background-color: #1a2332;
        border: 1px solid var(--border)
    }

    .progress-bar.questions {
        background: linear-gradient(90deg,#ff8800,#ffb454)
    }

    .progress-bar.messages {
        background: linear-gradient(90deg,#22c55e,#86efac)
    }

    /* Küçük istat kutuları */
    .mini-stat .value {
        font-weight: 700;
        font-size: 1.35rem
    }

    .mini-stat .label {
        font-size: .8rem;
        color: var(--muted)
    }

    /* Foto grid */
    .progress-photo {
        height: 64px;
        width: auto;
        border-radius: 10px;
        border: 1px solid var(--border);
        box-shadow: 0 6px 16px rgba(0,0,0,.18)
    }
</style>

<div class="container-fluid py-2">

    <!-- Üst Profil Satırı -->
    <div class="card ring shadow-soft report-card mb-3">
        <div class="card-body d-flex flex-wrap align-items-center gap-3">
            <img src="@Model.ProfilePhotoUrl" class="avatar-lg ring" alt="avatar" />
            <div class="me-auto">
                <div class="d-flex align-items-center gap-2 flex-wrap">
                    <h3 class="m-0">@Model.FullName</h3>
                    <span class="badge text-bg-secondary">@Model.UserId</span>
                </div>
                <div class="info-chip">@Model.Email</div>
                <div class="info-chip">Kayıt: @Model.RegisteredAt?.ToLocalTime().ToString("dd.MM.yyyy HH:mm")</div>
            </div>
            <div class="d-flex gap-2">
                <a class="btn btn-outline-secondary" asp-area="Admin" asp-controller="Students" asp-action="Report" asp-route-userId="@Model.UserId">
                    <i class="bi bi-arrow-clockwise"></i> Yenile
                </a>
                <button class="btn btn-outline-primary" disabled title="Yakında">
                    <i class="bi bi-filetype-pdf"></i> PDF
                </button>
            </div>
        </div>
    </div>

    <!-- Özet Kartları -->
    <div class="row g-3 mb-3">
        <!-- Paket -->
        <div class="col-xl-4 col-md-6">
            <div class="card ring shadow-soft h-100">
                <div class="card-body">
                    <div class="info-chip mb-1">Aktif Paket</div>
                    <div class="fw-bold fs-5">@Model.Package?.Name ?? "—"</div>
                    <div class="info-chip mb-3">@Model.Package?.Start?.ToString("dd.MM.yyyy") – @Model.Package?.End?.ToString("dd.MM.yyyy")</div>

                    <div class="mini-stat mb-2">
                        <div class="d-flex justify-content-between">
                            <span class="label">Soru</span>
                            <span class="label">@Model.Package?.UsedQuestions / @Model.Package?.TotalQuestions</span>
                        </div>
                        <div class="progress mt-1" style="height:8px">
                            <div class="progress-bar questions" role="progressbar" style="width:@qPct%"></div>
                        </div>
                        <div class="info-chip mt-1">Kalan: @Model.Package?.AvailableQuestions</div>
                    </div>

                    <div class="mini-stat">
                        <div class="d-flex justify-content-between">
                            <span class="label">Mesaj</span>
                            <span class="label">@Model.Package?.UsedMessages / @Model.Package?.TotalMessages</span>
                        </div>
                        <div class="progress mt-1" style="height:8px">
                            <div class="progress-bar messages" role="progressbar" style="width:@mPct%"></div>
                        </div>
                        <div class="info-chip mt-1">Kalan: @Model.Package?.AvailableMessages</div>
                    </div>

                    <div class="info-chip mt-3">
                        Aktif Ek Haklar: Soru +@Model.Package?.ActiveExtraQuestionRights, Mesaj +@Model.Package?.ActiveExtraMessageRights
                    </div>
                </div>
            </div>
        </div>

        <!-- Son Ölçüm -->
        <div class="col-xl-4 col-md-6">
            <div class="card ring shadow-soft h-100">
                <div class="card-body">
                    <div class="info-chip mb-1">Son Ölçüm</div>
                    <div class="fw-bold">@Model.WeeklyForm?.LastFormDate?.ToString("dd.MM.yyyy") ?? "—"</div>

                    <div class="row row-cols-3 text-center mt-2 g-2">
                        <div class="col mini-stat">
                            <div class="value">@((Model.WeeklyForm?.Weight)?.ToString("0.0") ?? "—")</div>
                            <div class="label">Kilo</div>
                        </div>
                        <div class="col mini-stat">
                            <div class="value">@((Model.WeeklyForm?.Waist)?.ToString("0.0") ?? "—")</div>
                            <div class="label">Bel</div>
                        </div>
                        <div class="col mini-stat">
                            <div class="value">@((Model.WeeklyForm?.Hip)?.ToString("0.0") ?? "—")</div>
                            <div class="label">Kalça</div>
                        </div>
                    </div>

                    @if (Model.WeeklyForm?.ProgressPhotoUrls?.Any() == true)
                    {
                        <div class="mt-3 d-flex flex-wrap gap-2">
                            @foreach (var url in Model.WeeklyForm.ProgressPhotoUrls.Take(3))
                            {
                                <img src="@url" class="progress-photo" alt="progress" />
                            }
                        </div>
                    }
                </div>
            </div>
        </div>

        <!-- İletişim Özeti -->
        <div class="col-xl-4 col-md-12">
            <div class="card ring shadow-soft h-100">
                <div class="card-body">
                    <div class="info-chip mb-1">İletişim Özeti (30g)</div>
                    <div class="d-flex align-items-center flex-wrap gap-4 mt-2">
                        <div class="mini-stat">
                            <div class="value">@Model.Comms?.Last30dMessageCount</div>
                            <div class="label">Mesaj</div>
                        </div>
                        <div class="mini-stat">
                            <div class="value">@Model.Comms?.Last30dQuestionCount</div>
                            <div class="label">Soru</div>
                        </div>
                        <div>
                            <div class="label">Son mesaj</div>
                            <div>@Model.Comms?.LastMessageAt?.ToLocalTime().ToString("dd.MM.yyyy HH:mm")</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Grafikler -->
    <div class="row g-3">
        <div class="col-lg-6">
            <div class="card ring shadow-soft">
                <div class="card-body">
                    <div class="info-chip mb-2">Kilo Değişimi</div>
                    <div class="chart-wrap"><canvas id="weightChart"></canvas></div>
                </div>
            </div>
        </div>
        <div class="col-lg-6">
            <div class="card ring shadow-soft">
                <div class="card-body">
                    <div class="info-chip mb-2">Bel / Kalça</div>
                    <div class="chart-wrap"><canvas id="waistChart"></canvas></div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Veri
        const weightLabels = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(
      Model.WeightSeries?.Select(x => x.Date.ToString("dd.MM")) ?? Array.Empty<string>()));
        const waistLabels  = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(
      Model.WaistSeries?.Select(x => x.Date.ToString("dd.MM")) ?? Array.Empty<string>()));

        const weightData = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(
      Model.WeightSeries?.Select(x => x.Value) ?? Array.Empty<double?>()));
        const waistData  = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(
      Model.WaistSeries?.Select(x => x.Value) ?? Array.Empty<double?>()));
        const hipData    = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(
      Model.HipSeries?.Select(x => x.Value) ?? Array.Empty<double?>()));

        // Temaya uyumlu eksen/legend renkleri
        const axis = getComputedStyle(document.documentElement);
        const txtColor  = axis.getPropertyValue('--text')?.trim() || '#e7edf5';
        const gridColor = '#2a3446';

        const commonOpts = {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { labels: { color: txtColor } },
            tooltip: { mode: 'index', intersect: false }
          },
          scales: {
            x: { ticks: { color: txtColor }, grid: { color: gridColor } },
            y: { ticks: { color: txtColor }, grid: { color: gridColor } }
          },
          elements: { line: { tension: .3 } }
        };

        const weightEl = document.getElementById('weightChart');
        if (weightEl && weightLabels.length && weightData.length){
          new Chart(weightEl, {
            type: 'line',
            data: {
              labels: weightLabels,
              datasets: [{
                label: 'Kilo',
                data: weightData,
                borderColor: '#ff8800',
                backgroundColor: 'rgba(255,136,0,.18)',
                pointRadius: 3
              }]
            },
            options: commonOpts
          });
        }

        const waistEl = document.getElementById('waistChart');
        if (waistEl && waistLabels.length && (waistData.length || hipData.length)){
          new Chart(waistEl, {
            type: 'line',
            data: {
              labels: waistLabels,
              datasets: [
                { label: 'Bel',   data: waistData, borderColor: '#60a5fa', backgroundColor: 'rgba(96,165,250,.18)', pointRadius:3 },
                { label: 'Kalça', data: hipData,   borderColor: '#a78bfa', backgroundColor: 'rgba(167,139,250,.18)', pointRadius:3 }
              ]
            },
            options: commonOpts
          });
        }
    </script>
}
