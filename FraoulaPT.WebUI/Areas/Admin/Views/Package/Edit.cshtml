@using FraoulaPT.WebUI.Areas.Admin.Models.ViewModels._Shared
@using FraoulaPT.Core.Enums
@using FraoulaPT.DTOs.PackageDTOs
@model PackageUpdateDTO

@{
    ViewData["Title"] = "Paketi Güncelle";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";

    var header = new PageHeaderVM
            {
                Title = "Paketi Güncelle",
                Subtitle = "Paket bilgilerini düzenleyin",
                Breadcrumbs = new(){
            new(){ Text="Dashboard", Url=Url.Action("Index","Dashboard", new{ area="Admin" }) },
            new(){ Text="Paketler", Url=Url.Action("Index","Package", new{ area="Admin" }) },
            new(){ Text="Düzenle" }
        },
                Buttons = new(){
            new(){ Text="Tüm Paketler", Url=Url.Action("Index","Package", new{ area="Admin"}), Icon="bi-box-seam", ColorClass="btn-outline-light" }
        }
            };
}

@await Html.PartialAsync("AdminPartials/_PageHeader", header)

<div class="container-fluid">
    <div class="row justify-content-center">
        <div class="col-12 col-xl-9">
            <div class="card ring shadow-soft">
                <div class="card-body p-3 p-md-4">
                    <form asp-area="Admin" asp-controller="Package" asp-action="Edit" method="post" enctype="multipart/form-data" autocomplete="off" id="pkgEditForm">
                        @Html.AntiForgeryToken()
                        <input type="hidden" asp-for="Id" />
                        <input type="hidden" asp-for="ImageUrl" />  @* mevcut görsel yolu *@
                        <div asp-validation-summary="ModelOnly" class="text-danger small mb-3"></div>

                        <div class="row g-3">
                            <div class="col-lg-6">
                                <label asp-for="Name" class="form-label">Paket Adı</label>
                                <input asp-for="Name" maxlength="80"
                                       class="form-control bg-transparent border-secondary text-light" required />
                                <div class="d-flex justify-content-between mt-1">
                                    <small class="text-muted">Mağaza kartlarında görünen isim.</small>
                                    <small class="text-muted"><span id="nameCount">0</span>/80</small>
                                </div>
                                <span asp-validation-for="Name" class="text-danger small"></span>
                            </div>

                            <div class="col-lg-3 col-md-6">
                                <label asp-for="PackageType" class="form-label">Paket Tipi</label>
                                <select asp-for="PackageType"
                                        asp-items="Html.GetEnumSelectList<PackageType>()"
                                        class="form-select bg-transparent border-secondary text-light" required>
                                    <option value="">Seçiniz</option>
                                </select>
                                <span asp-validation-for="PackageType" class="text-danger small"></span>
                            </div>

                            <div class="col-lg-3 col-md-6">
                                <label asp-for="SubscriptionPeriod" class="form-label">Süre</label>
                                <select asp-for="SubscriptionPeriod"
                                        asp-items="Html.GetEnumSelectList<SubscriptionPeriod>()"
                                        class="form-select bg-transparent border-secondary text-light" required>
                                    <option value="">Seçiniz</option>
                                </select>
                                <span asp-validation-for="SubscriptionPeriod" class="text-danger small"></span>
                            </div>

                            <div class="col-md-4">
                                <label asp-for="MaxQuestionsPerPeriod" class="form-label">Soru Hakkı</label>
                                <input asp-for="MaxQuestionsPerPeriod" type="number" min="0" step="1"
                                       class="form-control bg-transparent border-secondary text-light" />
                                <span asp-validation-for="MaxQuestionsPerPeriod" class="text-danger small"></span>
                            </div>

                            <div class="col-md-4">
                                <label asp-for="MaxMessagesPerPeriod" class="form-label">Mesaj Hakkı</label>
                                <input asp-for="MaxMessagesPerPeriod" type="number" min="0" step="1"
                                       class="form-control bg-transparent border-secondary text-light" />
                                <span asp-validation-for="MaxMessagesPerPeriod" class="text-danger small"></span>
                            </div>

                            <div class="col-md-4">
                                <label asp-for="Price" class="form-label">Fiyat (₺)</label>
                                <input asp-for="Price" type="number" min="0" step="0.01" inputmode="decimal"
                                       class="form-control bg-transparent border-secondary text-light" />
                                <span asp-validation-for="Price" class="text-danger small"></span>
                            </div>

                            <div class="col-md-4">
                                <label asp-for="Order" class="form-label">Sıra</label>
                                <input asp-for="Order" type="number" min="0" step="1"
                                       class="form-control bg-transparent border-secondary text-light"
                                       placeholder="Listeleme önceliği" />
                                <span asp-validation-for="Order" class="text-danger small"></span>
                            </div>

                            <div class="col-md-4">
                                <label class="form-label">Vitrin Rengi</label>
                                <div class="input-group">
                                    <input type="color" id="colorPicker" class="form-control form-control-color"
                                           value="@(string.IsNullOrWhiteSpace(Model?.HighlightColor) ? "#ff8800" : Model.HighlightColor)">
                                    <input asp-for="HighlightColor" id="colorHex"
                                           class="form-control bg-transparent border-secondary text-light"
                                           placeholder="#FFAA00" />
                                </div>
                                <small class="text-muted">Kart kenarı/etiket vurgusu için.</small>
                                <span asp-validation-for="HighlightColor" class="text-danger small"></span>
                            </div>

                            <div class="col-md-4">
                                <label class="form-label">Mevcut Görsel</label>
                                <div class="d-flex align-items-center gap-2">
                                    <img id="imgPreview"
                                         src="@(string.IsNullOrWhiteSpace(Model?.ImageUrl) ? "/uploads/placeholder.png" : Model.ImageUrl)"
                                         class="rounded ring" style="width:68px;height:68px;object-fit:cover;" alt="Önizleme">
                                    <small class="text-muted">Yeni görsel seçerseniz önizleme güncellenir.</small>
                                </div>
                                <div class="mt-2">
                                    <label asp-for="ImageFile" class="form-label">Yeni Görsel (opsiyonel)</label>
                                    <input asp-for="ImageFile" type="file" accept="image/*"
                                           class="form-control bg-transparent border-secondary text-light" />
                                    <span asp-validation-for="ImageFile" class="text-danger small"></span>
                                </div>
                            </div>

                            <div class="col-12">
                                <label asp-for="Description" class="form-label">Açıklama</label>
                                <textarea asp-for="Description" rows="3"
                                          class="form-control bg-transparent border-secondary text-light"></textarea>
                                <span asp-validation-for="Description" class="text-danger small"></span>
                            </div>

                            <div class="col-12">
                                <div class="d-flex justify-content-between align-items-center">
                                    <label asp-for="Features" class="form-label mb-0">Özellikler</label>
                                    <div id="featState" class="badge text-bg-secondary">Metin</div>
                                </div>
                                <textarea asp-for="Features" rows="3"
                                          class="form-control bg-transparent border-secondary text-light"
                                          placeholder='Metin girebilir veya geçerli JSON kullanabilirsiniz. Örn: { "includes": ["Haftalık plan", "Sınırsız mesaj"] }'></textarea>
                                <div class="d-flex gap-2 mt-2">
                                    <button class="btn btn-sm btn-outline-secondary" type="button" id="btnPrettyJson">
                                        <i class="bi bi-braces"></i> JSON Biçimlendir
                                    </button>
                                    <button class="btn btn-sm btn-outline-secondary" type="button" id="btnSampleJson">
                                        <i class="bi bi-stars"></i> Örnek JSON
                                    </button>
                                </div>
                                <span asp-validation-for="Features" class="text-danger small"></span>
                            </div>

                            <div class="col-12">
                                <div class="form-check form-switch">
                                    <input asp-for="IsActive" class="form-check-input" id="isActiveSwitch" />
                                    <label class="form-check-label" for="isActiveSwitch">@(@Model?.IsActive == true ? "Aktif" : "Pasif")</label>
                                </div>
                                <span asp-validation-for="IsActive" class="text-danger small"></span>
                            </div>
                        </div>

                        <div class="d-flex flex-wrap justify-content-end gap-2 mt-4">
                            <a asp-area="Admin" asp-controller="Package" asp-action="Index" class="btn btn-outline-secondary">
                                <i class="bi bi-arrow-left me-1"></i> Geri
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-save me-1"></i> Güncelle
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        (function(){
          const nameEl = document.getElementById("Name");
          const nameC  = document.getElementById("nameCount");
          const colorPicker = document.getElementById("colorPicker");
          const colorHex    = document.getElementById("colorHex");
          const imgInput    = document.getElementById("ImageFile");
          const imgPrev     = document.getElementById("imgPreview");
          const featTA      = document.getElementById("Features");
          const featState   = document.getElementById("featState");
          const prettyBtn   = document.getElementById("btnPrettyJson");
          const sampleBtn   = document.getElementById("btnSampleJson");
          const activeSwitch= document.getElementById("isActiveSwitch");
          const activeLbl   = document.querySelector("label[for='isActiveSwitch']");

          // İsim sayacı
          const updCount = ()=> { if(nameEl && nameC) nameC.textContent = (nameEl.value||"").length; };
          nameEl?.addEventListener("input", updCount); updCount();

          // Renk senkronizasyonu
          const syncColorToHex = ()=> { if(colorHex) colorHex.value = colorPicker.value; };
          const syncHexToColor = ()=>{
            const v = (colorHex?.value || "").trim();
            if(/^#([0-9a-f]{3}|[0-9a-f]{6})$/i.test(v)){ colorPicker.value = v; }
          };
          colorPicker?.addEventListener("input", syncColorToHex);
          colorHex?.addEventListener("input", syncHexToColor);
          if(colorHex?.value) syncHexToColor();

          // Görsel önizleme
          imgInput?.addEventListener("change", (e)=>{
            const f = e.target.files?.[0]; if(!f) return;
            const url = URL.createObjectURL(f);
            imgPrev.src = url;
          });

          // Özellikler alanı: JSON tespiti/doğrulama
          function validateFeatures(){
            const t = (featTA?.value || "").trim();
            if(!t){ featState.className = "badge text-bg-secondary"; featState.textContent="Metin"; return; }
            try{
              JSON.parse(t);
              featState.className = "badge text-bg-success";
              featState.textContent = "JSON ✓";
            }catch{
              featState.className = "badge text-bg-secondary";
              featState.textContent = "Metin";
            }
          }
          featTA?.addEventListener("input", validateFeatures); validateFeatures();

          // JSON biçimlendirme
          prettyBtn?.addEventListener("click", ()=>{
            const t = (featTA?.value || "").trim(); if(!t) return;
            try{
              const obj = JSON.parse(t);
              featTA.value = JSON.stringify(obj, null, 2);
              validateFeatures();
            }catch{
              // metinse sessiz geç
            }
          });

          // Örnek JSON doldur
          sampleBtn?.addEventListener("click", ()=>{
            const sample = {
              includes: ["Haftalık antrenman planı", "Aylık değerlendirme"],
              perks: { support:"Sohbet", priority:true },
              limits: { questions: 20, messages: 200 }
            };
            featTA.value = JSON.stringify(sample, null, 2);
            validateFeatures();
          });

          // Switch etiketi canlı güncelle
          activeSwitch?.addEventListener("change", ()=> {
            if(activeLbl) activeLbl.textContent = activeSwitch.checked ? "Aktif" : "Pasif";
          });

          // Sayısal alanların e/E +/− girişini engelle
          ["MaxQuestionsPerPeriod","MaxMessagesPerPeriod","Price","Order"].forEach(id=>{
            const el = document.getElementById(id);
            el?.addEventListener("input", ()=>{
              el.value = el.value.replace(/[eE\+\-]/g,"");
              if(+el.value < 0) el.value = 0;
            });
          });
        })();
    </script>
}
